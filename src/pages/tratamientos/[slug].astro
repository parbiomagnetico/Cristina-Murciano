---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Nav from "../../components/Nav.astro";
import Footer from "../../components/Footer.astro";
import { Picture } from "astro:assets";
import { getCollection, render } from "astro:content";
import content from "../../data/content.json";
import reviews from "../../data/reviews.json";

export async function getStaticPaths() {
    const services = await getCollection("services");
    return services.map((service) => ({
        params: { slug: service.slug },
        props: { service },
    }));
}

const { service } = Astro.props;
const { Content } = await render(service);
const waPhone = content.company.phone.replace(/[^0-9]/g, "");

const images = import.meta.glob<{ default: ImageMetadata }>(
    "/src/assets/images/*.{png,webp,jpg,jpeg}",
    { eager: true },
);
const imageSrc = images[`/src/assets/images/${service.data.image}`]?.default;
const ogImage = imageSrc ? imageSrc.src : undefined;

const schema = {
    "@context": "https://schema.org",
    "@type": "Service",
    name: service.data.title,
    description: service.data.shortDescription,
    image: ogImage ? new URL(ogImage, Astro.url).href : undefined,
    provider: {
        "@type": "LocalBusiness",
        name: content.company.name,
        address: content.company.address,
        telephone: content.company.phone,
    },
};

// Map slugs to specific reviews or keywords
const reviewKeywords: Record<string, string[]> = {
    "masaje-muscular": [
        "muscular",
        "descontracturante",
        "contractura",
        "espalda",
        "lumbares",
        "cuello",
        "tensión",
    ],
    bambuterapia: ["bambú", "cañas"],
    "piedras-calientes": ["piedras calientes", "volcánicas"],
    "masaje-circulatorio": [
        "piernas",
        "circulatorio",
        "linfático",
        "retención",
        "líquidos",
        "hinchadas",
        "descanso",
    ],
    reflexoterapia: ["reflexologia", "pies", "reflexoterapia"],
    "masaje-metamorfico": ["metamórfico", "metamórfica", "niño interior"],
    craneosacral: ["craneosacral"],
    "masaje-antiestres": [
        "antiestrés",
        "estrés",
        "relajación",
        "paz",
        "bienestar",
        "calma",
    ],
};

const keywords = reviewKeywords[service.slug] || [];
const relatedReviews = reviews
    .filter((r) => {
        const content = r.content.toLowerCase();
        return keywords.some((keyword) =>
            content.includes(keyword.toLowerCase()),
        );
    })
    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
    .slice(0, 2);

// Fallback to latest reviews if no specific matches found
const displayReviews =
    relatedReviews.length > 0 ? relatedReviews : reviews.slice(0, 2);

// Related Treatments Logic
const allServices = await getCollection("services");
const relatedTreatments = allServices
    .filter((s) => s.slug !== service.slug)
    .sort(() => 0.5 - Math.random()) // Randomize for variety
    .slice(0, 3);
---

<BaseLayout
    title={`${service.data.title} | Tratamientos Cristina Murciano`}
    description={service.data.shortDescription}
    image={ogImage}
>
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    <Nav />

    <main class="pt-32 pb-20">
        <header class="text-center px-6 mb-16 max-w-4xl mx-auto">
            <span
                class="text-teal-600 font-medium tracking-widest uppercase text-sm mb-4 block"
            >
                {service.data.categoryLabel || "Tratamiento"}
            </span>
            <h1
                class="text-4xl md:text-5xl font-serif text-gray-900 mb-6 leading-tight"
            >
                {service.data.title}
            </h1>
            <p class="text-xl text-gray-500 font-light max-w-2xl mx-auto">
                {service.data.shortDescription}
            </p>
        </header>

        <article class="max-w-4xl mx-auto px-6">
            <div
                class="aspect-video bg-gray-200 rounded-[2.5rem] overflow-hidden shadow-xl mb-16 relative group"
            >
                {
                    imageSrc && (
                        <Picture
                            src={imageSrc}
                            alt={service.data.image_alt || service.data.title}
                            formats={["avif", "webp"]}
                            widths={[400, 800, 1200]}
                            sizes="(max-width: 1024px) 100vw, 896px"
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                            loading="eager"
                            fetchpriority="high"
                        />
                    )
                }
                <div
                    class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"
                >
                </div>
            </div>

            <div
                class="prose prose-lg prose-gray mx-auto prose-headings:font-serif prose-headings:text-gray-900 prose-p:font-light prose-p:text-gray-600 prose-li:font-light prose-li:text-gray-600 prose-strong:font-medium prose-strong:text-gray-800 prose-a:text-teal-600 hover:prose-a:text-lilac-600 reveal"
            >
                <div
                    class="bg-white p-8 md:p-12 rounded-3xl shadow-sm border border-gray-100 mb-12"
                >
                    <Content />
                </div>
            </div>

            <!-- CTA Section -->
            <div
                class="mt-16 bg-gradient-to-br from-teal-50 to-lilac-50 p-8 md:p-12 rounded-[2.5rem] text-center relative overflow-hidden reveal"
            >
                <!-- Decorative background elements -->
                <div
                    class="absolute -top-20 -left-20 w-64 h-64 bg-teal-100/50 rounded-full blur-3xl pointer-events-none"
                >
                </div>
                <div
                    class="absolute -bottom-20 -right-20 w-64 h-64 bg-lilac-100/50 rounded-full blur-3xl pointer-events-none"
                >
                </div>

                <div class="relative z-10">
                    <h3 class="text-3xl font-serif text-gray-800 mb-4">
                        ¿Te interesa este tratamiento?
                    </h3>
                    <p
                        class="text-gray-600 mb-8 max-w-lg mx-auto font-light text-lg"
                    >
                        Reserva tu cita ahora y empieza a cuidar de ti. Atiendo
                        de forma personalizada en mi consulta de <strong
                            >Monzón</strong
                        >.
                    </p>
                    <div
                        class="flex flex-col sm:flex-row gap-4 justify-center items-center"
                    >
                        <a
                            href={`https://wa.me/${waPhone}?text=Hola, me gustaría reservar una sesión de ${service.data.title}`}
                            target="_blank"
                            class="px-8 py-4 bg-teal-600 text-white rounded-full font-medium hover:bg-teal-700 transition-all shadow-lg shadow-teal-900/20 hover:-translate-y-1"
                        >
                            Reservar Cita por WhatsApp
                        </a>
                        <a
                            href="/tratamientos"
                            class="px-8 py-4 bg-white text-gray-700 border border-gray-200 rounded-full font-medium hover:border-teal-300 transition-colors"
                        >
                            Ver todos los tratamientos
                        </a>
                    </div>
                </div>
            </div>

            {
                displayReviews.length > 0 && (
                    <div class="mt-24 reveal">
                        <div class="text-center mb-12">
                            <span class="text-xs font-semibold text-teal-600 uppercase tracking-widest mb-2 block">
                                Experiencias Reales
                            </span>
                            <h2 class="text-3xl font-serif text-gray-800 italic">
                                Opiniones de mis clientes
                            </h2>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            {displayReviews.map((review) => (
                                <div class="glass-panel rounded-3xl p-8 relative">
                                    <div class="absolute top-6 right-8 text-teal-100 italic font-serif text-6xl pointer-events-none select-none">
                                        “
                                    </div>
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 font-bold text-sm">
                                            {review.author
                                                .charAt(0)
                                                .toUpperCase()}
                                        </div>
                                        <div>
                                            <h4 class="font-serif text-gray-900 text-sm leading-none">
                                                {review.author}
                                            </h4>
                                            <span class="text-[10px] text-gray-400">
                                                {review.date}
                                            </span>
                                        </div>
                                    </div>
                                    <p class="text-gray-600 font-light text-sm leading-relaxed relative z-10 italic">
                                        "
                                        {review.content.length > 250
                                            ? review.content.substring(0, 250) +
                                              "..."
                                            : review.content}
                                        "
                                    </p>
                                    <div class="mt-4 flex gap-0.5">
                                        {[...Array(5)].map((_, i) => (
                                            <span class="text-teal-400 text-xs text-lilac-300">
                                                ★
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div class="text-center mt-8">
                            <a
                                href="/opiniones"
                                class="text-sm font-medium text-teal-600 hover:text-lilac-600 transition-colors"
                            >
                                Ver todas las opiniones →
                            </a>
                        </div>
                    </div>
                )
            }
        </article>

        {
            relatedTreatments.length > 0 && (
                <section class="max-w-7xl mx-auto mt-32 px-6 reveal">
                    <div class="text-center mb-16">
                        <h2 class="text-teal-600 font-sans font-medium tracking-widest uppercase text-sm mb-4">
                            Sigue explorando
                        </h2>
                        <h3 class="text-4xl font-serif text-gray-800 reveal-heading">
                            Otros tratamientos para{" "}
                            <span class="holographic-text">cuidarte</span>
                        </h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {relatedTreatments.map((t) => {
                            const tImage =
                                images[`/src/assets/images/${t.data.image}`]
                                    ?.default;
                            return (
                                <a
                                    href={`/tratamientos/${t.slug}`}
                                    class="glass-panel rounded-3xl overflow-hidden hover:-translate-y-2 cursor-pointer group flex flex-col transition-all duration-300"
                                >
                                    <div class="h-48 overflow-hidden relative">
                                        {tImage && (
                                            <Picture
                                                src={tImage}
                                                alt={
                                                    t.data.image_alt ||
                                                    t.data.title
                                                }
                                                formats={["avif", "webp"]}
                                                widths={[400, 800]}
                                                sizes="(max-width: 768px) 100vw, 400px"
                                                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                            />
                                        )}
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent" />
                                    </div>
                                    <div class="p-6 flex flex-col flex-grow">
                                        <h4 class="text-xl font-serif text-gray-800 mb-2 group-hover:text-teal-600 transition-colors">
                                            {t.data.title}
                                        </h4>
                                        <p class="text-gray-600 font-light text-sm line-clamp-2 leading-relaxed flex-grow">
                                            {t.data.shortDescription}
                                        </p>
                                    </div>
                                </a>
                            );
                        })}
                    </div>
                </section>
            )
        }
    </main>

    <Footer />
</BaseLayout>
